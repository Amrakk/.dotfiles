#!/usr/bin/env bash
set -euo pipefail

# --- locate build_info.json (Arch typical paths) ------------------------------
find_json() {
  local candidates=(
    "/usr/lib/discord/resources/build_info.json"
    "/usr/lib/discord-ptb/resources/build_info.json"
    "/usr/lib/discord-canary/resources/build_info.json"
    "/opt/discord/resources/build_info.json"
  )
  for f in "${candidates[@]}"; do [[ -f "$f" ]] && { echo "$f"; return 0; }; done
  mapfile -t found < <(find /usr /opt -type f -path "*/discord*/resources/build_info.json" 2>/dev/null || true)
  [[ ${#found[@]} -gt 0 ]] && { echo "${found[0]}"; return 0; }
  return 1
}

JSON="$(find_json || true)"
[[ -z "${JSON:-}" ]] && { echo "Could not locate build_info.json"; exit 1; }

ROOT="${JSON%/resources/build_info.json}"

have() { command -v "$1" >/dev/null 2>&1; }

read_field() {
  local key="$1"
  if have jq; then
    jq -r --arg k "$key" '.[$k] // empty' "$JSON"
  else
    grep -oE "\"$key\"[[:space:]]*:[[:space:]]*\"[^\"]+\"" "$JSON" \
      | head -1 | sed -E 's/.*"[[:space:]]*:[[:space:]]*"([^"]+)".*/\1/'
  fi
}

LOCAL_CHANNEL="$(read_field releaseChannel)"
LOCAL_VERSION="$(read_field version)"

# Normalize/fallback channel
norm_chan() {
  case "${1,,}" in
    stable|release|"") echo "stable" ;;
    ptb|public_test|public-test) echo "ptb" ;;
    canary|beta) echo "canary" ;;
    *) echo "stable" ;;
  esac
}
CHAN_FROM_FILE="$(norm_chan "${LOCAL_CHANNEL:-}")"
CHAN="${CHAN:-$CHAN_FROM_FILE}"

# --- FIX 1: resolve a SINGLE upstream URL and extract ONE version -------------
REMOTE_URL="$(curl -fsSLI -o /dev/null -w '%{url_effective}' \
  "https://discord.com/api/download/${CHAN}?platform=linux&format=tar.gz")"
REMOTE_VER="$(printf '%s' "$REMOTE_URL" | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | head -1)"

if [[ -z "${REMOTE_VER:-}" ]]; then
  echo "Unable to resolve upstream version for channel=$CHAN"
  exit 2
fi

# Trim any stray whitespace/newlines just in case
REMOTE_VER="${REMOTE_VER//$'\n'/}"
REMOTE_VER="${REMOTE_VER//$'\r'/}"

printf "JSON: %s\n" "$JSON"
printf "releaseChannel(local): %s  → channel: %s\n" "${LOCAL_CHANNEL:-<unset>}" "$CHAN"
printf "version(local): %s\n" "${LOCAL_VERSION:-<unset>}"
printf "version(upstream %s): %s\n" "$CHAN" "$REMOTE_VER"

# --- FIX 2: safe, atomic write (jq OR full rewrite), no sed-patching JSON ----
if [[ "$LOCAL_VERSION" != "$REMOTE_VER" || -z "${LOCAL_VERSION:-}" ]]; then
  echo "Updating build_info.json → version=${REMOTE_VER}, releaseChannel=${CHAN}"
  mkdir -p "$HOME/.cache/discord-buildinfo/backups"
  cp -n "$JSON" "$HOME/.cache/discord-buildinfo/backups/build_info.json.bak.$(date +%s)" 2>/dev/null || true

  tmp="$(mktemp)"
  if have jq; then
    jq --arg v "$REMOTE_VER" --arg ch "$CHAN" \
       '.version=$v | .releaseChannel=$ch' "$JSON" > "$tmp"
  else
    # Recreate minimal correct JSON
    printf '{\n  "releaseChannel": "%s",\n  "version": "%s"\n}\n' \
      "$CHAN" "$REMOTE_VER" > "$tmp"
  fi
  cat "$tmp" > "$JSON"
  rm -f "$tmp"
  echo "build_info.json updated."
else
  echo "Local version already matches upstream."
fi

# --- LAUNCH real Electron binary directly (avoid recursion) -------------------
REAL_BIN="$ROOT/Discord"
if [[ -x "$REAL_BIN" ]]; then
  exec "$REAL_BIN" "$@"
fi

for cand in "/usr/lib/discord/Discord" "/usr/lib/discord-ptb/Discord" "/usr/lib/discord-canary/Discord"; do
  [[ -x "$cand" ]] && exec "$cand" "$@"
done

echo "Could not find the real Discord binary (expected $ROOT/Discord)."
exit 3

