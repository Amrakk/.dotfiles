#!/usr/bin/env bash
set -euo pipefail

# --- locate build_info.json (Arch typical paths) ------------------------------
find_json() {
  local candidates=(
    "/usr/lib/discord/resources/build_info.json"
    "/usr/lib/discord-ptb/resources/build_info.json"
    "/usr/lib/discord-canary/resources/build_info.json"
    "/opt/discord/resources/build_info.json"
  )
  for f in "${candidates[@]}"; do [[ -f "$f" ]] && { echo "$f"; return 0; }; done
  # last resort: slow search
  mapfile -t found < <(find /usr /opt -type f -path "*/discord*/resources/build_info.json" 2>/dev/null || true)
  [[ ${#found[@]} -gt 0 ]] && { echo "${found[0]}"; return 0; }
  return 1
}

JSON="$(find_json || true)"
if [[ -z "${JSON:-}" ]]; then
  echo "Could not locate build_info.json. Is Discord installed?"
  exit 1
fi

ROOT="${JSON%/resources/build_info.json}"

# --- read fields from JSON ----------------------------------------------------
have() { command -v "$1" >/dev/null 2>&1; }

read_field() {
  local key="$1"
  if have jq; then
    jq -r --arg k "$key" '.[$k] // empty' "$JSON"
  else
    # naive grep/sed fallback (expects simple flat JSON keys)
    grep -oE "\"$key\"[[:space:]]*:[[:space:]]*\"[^\"]+\"" "$JSON" \
      | head -1 | sed -E 's/.*"[[:space:]]*:[[:space:]]*"([^"]+)".*/\1/'
  fi
}

LOCAL_CHANNEL="$(read_field releaseChannel)"
LOCAL_VERSION="$(read_field version)"

# Normalize channel from file; fallback to env CHAN or stable.
norm_chan() {
  case "${1,,}" in
    stable|release|"") echo "stable" ;;
    ptb|public_test|public-test) echo "ptb" ;;
    canary|beta) echo "canary" ;;
    *) echo "stable" ;;
  esac
}
CHAN_FROM_FILE="$(norm_chan "${LOCAL_CHANNEL:-}")"
CHAN="${CHAN:-$CHAN_FROM_FILE}"

# --- determine the matching binary name to launch -----------------------------
case "$CHAN" in
  ptb)    BIN="discord-ptb" ;;
  canary) BIN="discord-canary" ;;
  *)      BIN="discord" ;;
esac

# --- fetch upstream latest version for that channel ---------------------------
REMOTE_VER=$(
  curl -sI "https://discord.com/api/download/${CHAN}?platform=linux&format=tar.gz" \
  | tr -d '\r' \
  | awk -F': ' 'tolower($1)=="location"{print $2}' \
  | grep -oE '[0-9]+\.[0-9]+\.[0-9]+'
)

if [[ -z "${REMOTE_VER:-}" ]]; then
  echo "Unable to resolve upstream version via redirect for channel=$CHAN"
  exit 2
fi

printf "Detected JSON: %s\n" "$JSON"
printf "releaseChannel(local): %s  => channel(normalized): %s\n" "${LOCAL_CHANNEL:-<unset>}" "$CHAN"
printf "version(local): %s\n" "${LOCAL_VERSION:-<unset>}"
printf "version(upstream %s): %s\n" "$CHAN" "$REMOTE_VER"

# --- update build_info.json if mismatch ---------------------------------------
if [[ "$LOCAL_VERSION" != "$REMOTE_VER" || -z "${LOCAL_VERSION:-}" ]]; then
  echo "Version mismatch â†’ updating JSON to ${REMOTE_VER}"
  sudo cp -n "$JSON" "$JSON.bak.$(date +%s)"
  if have jq; then
    tmp="$(mktemp)"
    jq --arg v "$REMOTE_VER" --arg ch "$CHAN" \
      '.version=$v | .releaseChannel=$ch' "$JSON" > "$tmp"
    sudo install -m 0644 "$tmp" "$JSON"
    rm -f "$tmp"
  else
    # Ensure releaseChannel exists and version is set (sed-only fallback)
    # 1) set or replace "version"
    sudo sed -i -E "{
      s/(\"version\"[[:space:]]*:[[:space:]]*\")[^\"]*(\")/\1${REMOTE_VER}\2/;
      t donev;
      $ a\\
\"version\": \"${REMOTE_VER}\"
      :donev
    }" "$JSON"
    # 2) set or replace "releaseChannel"
    sudo sed -i -E "{
      s/(\"releaseChannel\"[[:space:]]*:[[:space:]]*\")[^\"]*(\")/\1${CHAN}\2/;
      t donec;
      1 i\\
\"releaseChannel\": \"${CHAN}\",
      :donec
    }" "$JSON"
  fi
  echo "build_info.json updated."
else
  echo "Local version already matches upstream."
fi

# --- launch Discord -----------------------------------------------------------
if command -v "$BIN" >/dev/null 2>&1; then
  exec "$BIN"
elif [[ -x "$ROOT/Discord" ]]; then
  exec "$ROOT/Discord"
else
  echo "Could not find executable for channel=$CHAN (tried $BIN and $ROOT/Discord)."
  exit 3
fi

